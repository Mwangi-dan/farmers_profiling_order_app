{% extends "base.html" %}

{% block title %}Users - ShambaBora{% endblock %}

{% block content %}
<main id="main" class="main">
  <div class="pagetitle">
    <h1>Users</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard' )}}">Home</a></li>
        <li class="breadcrumb-item active">Users</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Users</h5>
      <p>View all users registered in the System</p>

      <!-- Filter Button -->
      <button type="button" class="btn btn-info mb-3" data-bs-toggle="modal" data-bs-target="#filterModal">Filter</button>

      <!-- Active Filters -->
      <div id="active-filters" class="mb-3"></div>

      <div class="table-responsive">
        <!-- Table with stripped rows -->
        <table class="table datatable" id="users-table">
          <thead>
            <tr>
              <th><b>Name</b></th>
              <th>Role</th>
              <th>Gender</th>
              <th>Telephone</th>
              <th>Location</th>
              <th data-type="date" data-format="YYYY/DD/MM">Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td><a href="{{ url_for('admin.view_user', user_id=user.id) }}">{{ user.name }}</a></td>
              <td>{{ user.role.capitalize() }}</td>
              <td>{{ user.gender }}</td>
              <td>{{ user.telephone }}</td>
              <td>{{ user.location }}</td>
              <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
              <td>
                <a href="{{ url_for('admin.view_user', user_id=user.id) }}" class="btn btn-primary mb-3">Edit User</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <!-- End Table with stripped rows -->
      </div>
  </div>

  <!-- Filter Modal -->
  <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filterModalLabel">Filter Users</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="filter-role" class="form-label">Filter by Role:</label>
            <select class="form-control" id="filter-role">
              <option value="">All</option>
              <option value="admin">Admin</option>
              <option value="farmer">Farmer</option>
              <option value="supplier">Supplier</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="filter-gender" class="form-label">Filter by Gender:</label>
            <select class="form-control" id="filter-gender">
              <option value="">All</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="filter-date" class="form-label">Filter by Date Joined:</label>
            <input type="date" class="form-control" id="filter-date">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="applyFilters()">Apply Filters</button>
        </div>
      </div>
    </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const roleFilter = document.getElementById('filter-role');
      const genderFilter = document.getElementById('filter-gender');
      const dateFilter = document.getElementById('filter-date');
      const table = document.getElementById('users-table');
      const rows = table.getElementsByTagName('tr');
      const activeFiltersDiv = document.getElementById('active-filters');

      window.applyFilters = function() {
          const role = roleFilter.value.toLowerCase();
          const gender = genderFilter.value.toLowerCase();
          const date = dateFilter.value;

          updateActiveFilters(role, gender, date);

          for (let i = 1; i < rows.length; i++) {
              let roleMatch = true;
              let genderMatch = true;
              let dateMatch = true;

              const cells = rows[i].getElementsByTagName('td');
              const rowRole = cells[1].innerText.toLowerCase();
              const rowGender = cells[2].innerText.toLowerCase();
              const rowDate = cells[5].innerText;

              if (role && rowRole !== role) {
                  roleMatch = false;
              }

              if (gender && rowGender !== gender) {
                  genderMatch = false;
              }

              if (date && rowDate !== date) {
                  dateMatch = false;
              }

              if (roleMatch && genderMatch && dateMatch) {
                  rows[i].style.display = '';
              } else {
                  rows[i].style.display = 'none';
              }
          }
      }

      function updateActiveFilters(role, gender, date) {
          activeFiltersDiv.innerHTML = '';

          if (role) {
              const roleFilterTag = createFilterTag('Role', role, () => {
                  roleFilter.value = '';
                  applyFilters();
              });
              activeFiltersDiv.appendChild(roleFilterTag);
          }

          if (gender) {
              const genderFilterTag = createFilterTag('Gender', gender, () => {
                  genderFilter.value = '';
                  applyFilters();
              });
              activeFiltersDiv.appendChild(genderFilterTag);
          }

          if (date) {
              const dateFilterTag = createFilterTag('Date Joined', date, () => {
                  dateFilter.value = '';
                  applyFilters();
              });
              activeFiltersDiv.appendChild(dateFilterTag);
          }
      }

      function createFilterTag(label, value, onClick) {
          const filterTag = document.createElement('div');
          filterTag.className = 'badge bg-primary text-white me-2';
          filterTag.innerHTML = `${label}: ${value} <span class="ms-2" style="cursor: pointer;">&times;</span>`;
          filterTag.querySelector('span').onclick = onClick;
          return filterTag;
      }
  });
</script>
{% endblock %}
