{% extends "base.html" %}

{% block title %}Products - ShambaBora{% endblock %}

{% block content %}
<main id="main" class="main">
    <div class="pagetitle">
        <h1>Products</h1>
        <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard' )}}">Home</a></li>
            <li class="breadcrumb-item active">Products</li>
        </ol>
        </nav>
    </div><!-- End Page Title -->
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="container mt-4">
          {% for category, message in messages %}
            {% if 'success' in category %}
              <div class="alert alert-{{ category.split('-')[0] }} alert-dismissible fade show profile-flash" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Products</h5>
            <p>View all products in the System</p>

      
            <a href="{{ url_for('admin.new_product') }}" class="btn btn-primary mb-3">Add Product</a>
        

            <!-- Filter Button -->
            <button type="button" class="btn btn-info mb-3" data-bs-toggle="modal" data-bs-target="#filterModal">Filter</button>

            <!-- Active Filters -->
            <div id="active-filters" class="mb-3"></div>

            <div class="table-responsive">
                <!-- Table with stripped rows -->
                <table class="table datatable" id="products-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th><b>Name</b></th>
                            <th>Category</th>
                            <th>Price (Kg/L)</th>
                            <th>Stock (Tonnes)</th>
                            <th>Supplier</th>
                            <th>Actions</th>
                            <th>Featured</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>
                                <a href="{{ url_for('admin.view_product', id=product.id) }}">
                                    <img src="{{ url_for('static', filename='images/product_uploads/' ~ product.image_url) }}"
                                         alt="{{ product.name }}"
                                         class="img-thumbnail"
                                         style="width: 75px; height: 75px; object-fit: cover;">
                                </a>
                            </td> 
                            <td><a href="{{ url_for('admin.view_product', id=product.id) }}">{{ product.name }}</a></td>
                            <td>{{ product.category }}</td>
                            <td>{{ product.currency }} {{ product.price }}</td>
                            <td>{{ product.quantity }}</td>
                            <td>{{ product.supplier.name }}</td>
                            <td>
                                <a href="{{ url_for('admin.edit_product', id=product.id) }}" class="btn btn-primary mb-3">Edit Product</a>
                            </td>
                            <td>
                                {% if product.featured %}
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#featureModal{{ product.id }}">Unfeature</button>
                                {% else %}
                                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#featureModal{{ product.id }}">Feature</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <!-- End Table with stripped rows -->



                {% for product in products %}
                <div class="modal fade" id="featureModal{{ product.id }}" tabindex="-1" aria-labelledby="featureModalLabel{{ product.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="featureModalLabel{{ product.id }}">
                                    {% if product.featured %}
                                        Unfeature Product: {{ product.name }}
                                    {% else %}
                                        Feature Product: {{ product.name }}
                                    {% endif %}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center mb-3">
                                    <img src="{{ url_for('static', filename='images/product_uploads/' ~ product.image_url) }}" 
                                         alt="{{ product.name }}" 
                                         class="img-fluid rounded shadow-sm" 
                                         style="max-height: 200px; object-fit: cover;">
                                </div>
                                {% if product.featured %}
                                    <p>Are you sure you want to unfeature this product?</p>
                                {% else %}
                                    <p>Are you sure you want to feature this product?</p>
                                {% endif %}
                        
                                <ul>
                                    <li><strong>Name:</strong> {{ product.name }}</li>
                                    <li><strong>Category:</strong> {{ product.category }}</li>
                                    <li><strong>Price:</strong> ${{ product.price }}</li>
                                    <li><strong>Stock:</strong> {{ product.quantity }}</li>
                                    <li><strong>Supplier:</strong> {{ product.supplier.name }}</li>
                                </ul>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                {% if product.featured %}
                                    <a href="{{ url_for('admin.toggle_feature', id=product.id, action='unfeature') }}" class="btn btn-danger">Yes, Unfeature</a>
                                {% else %}
                                    <a href="{{ url_for('admin.toggle_feature', id=product.id, action='feature') }}" class="btn btn-success">Yes, Feature</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}


</main>
{% endblock %}